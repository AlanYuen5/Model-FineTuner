# PromptTrainer - Excel到JSONL训练数据转换工具

## 项目概述

PromptTrainer是一个用于将Excel格式的对话数据转换为JSONL格式训练数据的工具。该工具特别适用于准备AI模型的训练数据，支持系统提示词(System Prompt)、用户输入(Input)和助手回复(Output)的三元组对话格式。

## 功能特性

### 核心功能
1. **Excel到JSONL转换**: 将Excel文件中的对话数据转换为OpenAI训练格式的JSONL文件
2. **智能列匹配**: 自动识别Excel文件中的列名，支持多种命名方式
3. **数据验证**: 自动跳过包含缺失数据的行
4. **完整的日志记录**: 使用专业的日志系统记录所有操作步骤

### 日志系统
- **多级别日志**: 支持DEBUG、INFO、WARNING、ERROR、CRITICAL等日志级别
- **双重输出**: 同时输出到控制台和日志文件
- **自动文件管理**: 按日期自动创建日志文件
- **详细步骤记录**: 记录文件读取、数据处理、转换结果等所有关键步骤

## 文件结构

```
PromptTrainer/
├── main.py           # 主程序文件
├── logger.py         # 日志系统模块
├── logs/            # 日志文件目录
├── ui/              # 用户界面模块
│   └── main_ui.py   # 主界面文件
└── README.md        # 项目说明文档
```

## 使用方法

### 1. 运行程序
```bash
python main.py
```

### 2. 输入Excel文件路径
程序会提示您输入Excel文件的路径，您可以：
- 直接输入文件的完整路径
- 拖拽文件到命令行窗口

### 3. Excel文件格式要求

您的Excel文件需要包含以下三种类型的列（列名不区分大小写）：

| 数据类型 | 支持的列名 |
|---------|------------|
| 系统提示词 | System Prompt, System_Prompt, System |
| 用户输入 | Input, User, Question |
| 助手回复 | Output, Assistant, Response, Answer |

**示例Excel格式：**
| System Prompt | Input | Output |
|--------------|-------|--------|
| 你是一个helpful助手 | 什么是人工智能？ | 人工智能是计算机科学的一个分支... |
| 你是专业的翻译助手 | 翻译：Hello World | 你好，世界 |

### 4. 输出结果

程序会在Excel文件的同一目录下生成一个JSONL文件，文件名为 `原文件名_training_data.jsonl`

**输出格式示例：**
```json
{
  "messages": [
    {"role": "system", "content": "你是一个helpful助手"},
    {"role": "user", "content": "什么是人工智能？"},
    {"role": "assistant", "content": "人工智能是计算机科学的一个分支..."}
  ]
}
```

## 日志功能说明

### 日志级别
- **INFO**: 记录程序的主要执行步骤和成功操作
- **WARNING**: 记录跳过的数据行和潜在问题
- **ERROR**: 记录错误信息，如文件读取失败等
- **DEBUG**: 记录详细的调试信息，如示例数据内容

### 日志输出位置
- **控制台**: 实时显示程序执行状态
- **日志文件**: 保存在 `logs/` 目录下，按日期命名 (如: `app_20241201.log`)

### 示例日志输出
```
2024-12-01 10:30:15 - __main__ - INFO - 程序启动
2024-12-01 10:30:20 - __main__ - INFO - 用户输入的文件路径: /path/to/data.xlsx
2024-12-01 10:30:21 - __main__ - INFO - 成功加载Excel文件: /path/to/data.xlsx
2024-12-01 10:30:21 - __main__ - INFO - 数据行数: 100
2024-12-01 10:30:21 - __main__ - INFO - 发现的列: ['System Prompt', 'Input', 'Output']
2024-12-01 10:30:21 - __main__ - INFO - 列映射关系: {'system_prompt': 'System Prompt', 'input': 'Input', 'output': 'Output'}
2024-12-01 10:30:22 - __main__ - INFO - 成功转换了95条对话到JSONL格式
2024-12-01 10:30:22 - __main__ - INFO - 输出文件: /path/to/data_training_data.jsonl
```

## 错误处理

程序具备完善的错误处理机制：

1. **文件不存在**: 检查并提示用户文件路径错误
2. **列名不匹配**: 提示用户Excel文件的列名格式问题
3. **数据缺失**: 自动跳过包含空值的行并记录
4. **文件读写错误**: 捕获并记录文件操作异常

## 技术特点

### 设计原则
- **SOLID原则**: 代码结构清晰，职责分离
- **错误监控**: 完善的异常处理和日志记录
- **用户友好**: 中文提示信息，易于理解

### 依赖库
- `pandas`: Excel文件读取和数据处理
- `json`: JSON数据格式处理
- `openai`: OpenAI API接口（为后续训练功能预留）

## 后续开发计划

1. **模型训练功能**: 完善 `train_model()` 函数，实现自动化模型训练
2. **图形界面**: 开发更友好的GUI界面
3. **批量处理**: 支持同时处理多个Excel文件
4. **数据预处理**: 增加数据清洗和验证功能
5. **格式扩展**: 支持更多输入格式（CSV、TSV等）

## 项目改进

### 最新改进（v1.2）
1. **修复变量作用域问题**: 解决gpt_fine_tuner.py中job_params变量的UnboundLocalError
2. **优化代码逻辑**: 重新组织create_fine_tune_job方法中的参数构建逻辑
3. **增强错误处理**: 确保所有变量在使用前都已正确初始化

### 历史改进（v1.1）
1. **完整日志系统**: 替换所有print语句为专业的日志记录
2. **中文本地化**: 所有提示信息改为中文，提升用户体验
3. **增强错误处理**: 添加文件存在性检查和更详细的错误信息
4. **代码文档**: 完善函数注释和类型说明
5. **结构优化**: 改进代码结构，提高可维护性

### 技术架构
- **模块化设计**: logger.py独立管理日志功能
- **配置管理**: 支持日志级别和输出方式的灵活配置
- **异常安全**: 所有关键操作都包含异常处理

## 使用建议

1. **准备数据**: 确保Excel文件格式正确，列名符合要求
2. **检查日志**: 运行后查看日志文件了解详细的处理过程
3. **验证输出**: 检查生成的JSONL文件格式是否符合预期
4. **备份数据**: 建议在处理重要数据前进行备份

---

如果您在使用过程中遇到任何问题，请查看日志文件中的详细信息，或联系开发团队获取支持。 